<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VICRO & KASSY | OMEGA GATE v30.0</title>
    <style>
        :root {
            --primary: #00ff41; --bg: #000; --card: rgba(10, 10, 10, 0.98);
            --red: #ff3333; --blue: #00ccff; --pink: #ff69b4;
            --text: var(--primary); --dim: #004400; --gold: #ffcc00;
        }
        body.vicro-theme { --primary: #00ff41; --dim: #004400; }
        body.kassy-theme { --primary: var(--pink); --dim: #440022; }
        body.user-blue { --primary: var(--blue); --dim: #002244; }
        body.user-gold { --primary: var(--gold); --dim: #443300; }
        
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: 'Courier New', monospace; overflow: hidden; color: var(--primary); transition: 0.5s; }
        #canvas-bg { position: fixed; inset: 0; z-index: -1; }

        #biometric-overlay { position: fixed; inset: 0; z-index: 3000; background: #000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .scanner-bar { width: 100%; height: 4px; background: var(--primary); position: absolute; top: 0; box-shadow: 0 0 20px var(--primary); animation: scanLine 2s linear infinite; }
        @keyframes scanLine { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }

        #login-page { position: fixed; inset: 0; z-index: 2000; background: #000; display: flex; justify-content: center; align-items: center; }
        .login-card { text-align: center; width: 90%; max-width: 380px; border: 1px solid var(--primary); padding: 30px; background: #000; box-shadow: 0 0 30px var(--dim); }
        .hacker-input { width: 100%; background: transparent; border: 1px solid var(--dim); padding: 12px; color: var(--primary); outline: none; margin-bottom: 10px; text-align: center; box-sizing: border-box; }
        .btn-hack { width: 100%; background: var(--primary); color: #000; border: none; padding: 12px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-bottom: 5px; }

        #color-selector { display: none; margin-bottom: 15px; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .color-opt { height: 25px; border: 1px solid #fff; cursor: pointer; }

        #main-app { display: none; height: 100vh; flex-direction: column; padding: 15px; box-sizing: border-box; }
        .header { display: flex; justify-content: space-between; border-bottom: 1px solid var(--dim); padding-bottom: 10px; margin-bottom: 10px; font-size: 0.7rem; }
        .content-grid { display: grid; grid-template-columns: 1fr; gap: 15px; overflow-y: auto; }
        @media (min-width: 850px) { .content-grid { grid-template-columns: 1.2fr 1fr; height: 80vh; } }

        .panel { background: var(--card); border: 1px solid var(--dim); padding: 20px; border-radius: 5px; margin-bottom: 15px; }
        .amount { font-size: 2.5rem; font-weight: bold; margin: 10px 0; cursor: pointer; }
        .log-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #222; font-size: 0.7rem; }
        .del-btn { color: var(--red); cursor: pointer; border: 1px solid var(--red); padding: 2px 5px; }

        .alert-box { background: var(--red); color: white; padding: 10px; margin-bottom: 10px; font-size: 0.7rem; cursor: pointer; animation: pulse 1s infinite; text-align: center; display: none; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        #player-vicro { background: #111; border: 1px solid var(--primary); padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        audio { height: 30px; width: 100%; filter: invert(1); margin-top: 5px; }
    </style>
</head>
<body id="body-tag">
    <canvas id="canvas-bg"></canvas>

    <div id="biometric-overlay">
        <div class="scanner-bar"></div>
        <div id="bio-msg">ESTABLECIENDO_CONEXIÓN_SEGURA...</div>
    </div>

    <div id="login-page">
        <div class="login-card">
            <h2 id="login-title">OMEGA_CLOUD_v30</h2>
            <input type="text" id="user" class="hacker-input" placeholder="USUARIO">
            <input type="password" id="pass" class="hacker-input" placeholder="CONTRASEÑA">
            
            <div id="color-selector">
                <div class="color-opt" style="background: #00ff41" onclick="selectColor('vicro-theme')"></div>
                <div class="color-opt" style="background: #ff69b4" onclick="selectColor('kassy-theme')"></div>
                <div class="color-opt" style="background: #00ccff" onclick="selectColor('user-blue')"></div>
                <div class="color-opt" style="background: #ffcc00" onclick="selectColor('user-gold')"></div>
            </div>

            <button id="btn-main" class="btn-hack" onclick="iniciarEscaneo()">ACCEDER</button>
            <div style="margin-top:10px; display: flex; flex-direction: column; gap: 5px;">
                <button id="btn-toggle" onclick="toggleAuthMode()" style="background:none; border:none; color:var(--blue); cursor:pointer; font-size:0.6rem;">[ REGISTRAR_NUEVO_ACCESO_VICRO ]</button>
                <button onclick="configAcceso()" style="background:none; border:none; color:var(--gold); cursor:pointer; font-size:0.5rem;">[ AJUSTES_GLOBALES ]</button>
            </div>
        </div>
    </div>

    <div id="main-app">
        <div class="header">
            <span id="display-user"></span>
            <span id="sync-indicator">● ONLINE</span>
            <button onclick="location.reload()" style="background:var(--red); color:white; border:none; padding: 2px 10px; cursor:pointer;">CERRAR</button>
        </div>

        <div id="admin-alert" class="alert-box" onclick="abrirAprobaciones()">⚠️ HAY SOLICITUDES DE ACCESO PENDIENTES [REVISAR]</div>

        <div id="player-vicro">
            <div style="display:flex; gap:5px;">
                <select id="track-list" onchange="changeTrack()" style="background:#000; color:var(--primary); flex-grow:1; border:1px solid var(--dim);">
                    <option value="">-- MÚSICA --</option>
                </select>
                <button onclick="addMusic()" style="background:var(--primary); border:none; padding:0 10px; font-weight:bold;">+</button>
            </div>
            <audio controls id="main-audio"></audio>
        </div>

        <div class="content-grid">
            <div class="panel" id="panel-controls"></div>
            <div class="panel">
                <small>[ HISTORIAL_VICRO ]</small>
                <div id="panel-logs"></div>
            </div>
        </div>
    </div>

    <script>
        const BIN_ID = '698bb9a743b1c97be975254f';
        const MASTER_KEY = '$2a$10$spjxIrYFxGQiKIYND0MrkOg3V6pY4nV.R/US9pa3CWpGr3Se2vutm';

        let db = {
            auth: {
                vicrocrook: { user: "vicrocrook", pass: "soyelmaster", theme: "vicro-theme", access: "vicro", active: true },
                kassy10: { user: "kassy10", pass: "ojitosbonitos", theme: "kassy-theme", access: "kassy", active: true }
            },
            data: {
                vicro_airtm: { saldo: 0, logs: [] },
                vicro_cap: { saldo: 0, logs: [] },
                kassy_caja: { saldo: 0, logs: [] }
            },
            playlist: []
        };

        let currentUser = "";
        let isRegisterMode = false;
        let selectedTheme = "vicro-theme";

        async function syncCloud(push = false) {
            try {
                if (push) {
                    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-Master-Key': MASTER_KEY },
                        body: JSON.stringify(db)
                    });
                } else {
                    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                        headers: { 'X-Master-Key': MASTER_KEY, 'X-Bin-Meta': 'false' }
                    });
                    const data = await res.json();
                    if(data.auth) db = data;
                }
                updatePlaylistUI();
                checkPendingUsers();
            } catch (e) { console.error("Sync error"); }
        }

        function checkPendingUsers() {
            if(currentUser !== "vicrocrook") return;
            const pendings = Object.values(db.auth).filter(u => u.active === false);
            document.getElementById('admin-alert').style.display = pendings.length > 0 ? 'block' : 'none';
        }

        async function abrirAprobaciones() {
            const pendings = Object.values(db.auth).filter(u => u.active === false);
            let msg = "OPERADORES ESPERANDO:\n";
            pendings.forEach(u => msg += `- ${u.user}\n`);
            let target = prompt(msg + "\nEscriba el nombre para APROBAR o cancelar:");
            
            if(target && db.auth[target.toLowerCase()]) {
                db.auth[target.toLowerCase()].active = true;
                await syncCloud(true);
                alert("OPERADOR ACTIVADO");
                checkPendingUsers();
            }
        }

        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            document.getElementById('color-selector').style.display = isRegisterMode ? 'grid' : 'none';
            document.getElementById('btn-main').innerText = isRegisterMode ? 'ENVIAR SOLICITUD' : 'ACCEDER';
        }

        function selectColor(t) { selectedTheme = t; document.body.className = t; }

        async function iniciarEscaneo() {
            const u = document.getElementById('user').value.trim().toLowerCase();
            const p = document.getElementById('pass').value.trim();
            document.getElementById('biometric-overlay').style.display = 'flex';
            await syncCloud();

            if (isRegisterMode) {
                if (db.auth[u]) { alert("USUARIO EXISTENTE"); }
                else {
                    db.auth[u] = { user: u, pass: p, theme: selectedTheme, access: "vicro", active: false };
                    await syncCloud(true);
                    alert("SOLICITUD ENVIADA. ESPERA A QUE VICRO TE APRUEBE.");
                    toggleAuthMode();
                }
                document.getElementById('biometric-overlay').style.display = 'none';
                return;
            }

            if (db.auth[u] && db.auth[u].pass === p) {
                if(db.auth[u].active === false) {
                    alert("ACCESO BLOQUEADO: Esperando aprobación de Vicro.");
                } else {
                    currentUser = u;
                    document.body.className = db.auth[u].theme;
                    document.getElementById('login-page').style.display = 'none';
                    showApp();
                }
            } else { alert("DATOS INCORRECTOS"); }
            document.getElementById('biometric-overlay').style.display = 'none';
        }

        async function configAcceso() {
            let target = prompt("Usuario a modificar:").toLowerCase();
            if(db.auth[target] && prompt("Master Key:") === "2026") {
                db.auth[target].user = prompt("Nuevo nombre:", db.auth[target].user);
                db.auth[target].pass = prompt("Nueva pass:", db.auth[target].pass);
                await syncCloud(true);
                alert("ACTUALIZADO");
            }
        }

        function showApp() {
            document.getElementById('main-app').style.display = 'flex';
            document.getElementById('display-user').innerText = "OP: " + currentUser.toUpperCase();
            updateUI();
            checkPendingUsers();
        }

        function updatePlaylistUI() {
            const list = document.getElementById('track-list');
            list.innerHTML = '<option value="">-- MÚSICA --</option>';
            db.playlist.forEach(t => list.add(new Option(t.name, t.file)));
        }

        function updateUI() {
            const controls = document.getElementById('panel-controls');
            controls.innerHTML = "";
            const acc = db.auth[currentUser].access;
            if(acc === "vicro") {
                renderNodo(controls, "vicro_airtm", "VICRO_AIRTM", "var(--blue)");
                renderNodo(controls, "vicro_cap", "VICRO_CAPITAL", "var(--primary)");
                renderLogs('vicro_airtm');
            } else {
                renderNodo(controls, "kassy_caja", "KASSY_CAJA ✨", "var(--pink)");
                renderLogs('kassy_caja');
            }
        }

        function renderNodo(parent, id, title, color) {
            parent.innerHTML += `
                <div style="margin-bottom: 20px;">
                    <small style="color:${color}">[ ${title} ]</small>
                    <div class="amount" style="color:${color}" onclick="ajustarSaldo('${id}')">$${db.data[id].saldo.toLocaleString()}</div>
                    <input type="text" id="c-${id}" class="hacker-input" placeholder="CONCEPTO">
                    <input type="number" id="m-${id}" class="hacker-input" placeholder="MONTO">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="btn-hack" style="background:${color}" onclick="registrar('${id}', 'INGRESO')">DEPÓSITO</button>
                        <button class="btn-hack" style="background:var(--red); color:white" onclick="registrar('${id}', 'GASTO')">GASTO</button>
                    </div>
                </div>`;
        }

        async function registrar(sec, tipo) {
            const det = document.getElementById(`c-${sec}`).value;
            const mon = parseFloat(document.getElementById(`m-${sec}`).value);
            if(!det || isNaN(mon)) return;
            db.data[sec].saldo += (tipo === 'INGRESO' ? mon : -mon);
            db.data[sec].logs.push({ id: Date.now(), concepto: det.toUpperCase(), monto: mon, tipo, op: currentUser });
            updateUI(); await syncCloud(true);
        }

        function renderLogs(sec) {
            const cont = document.getElementById('panel-logs');
            cont.innerHTML = "";
            [...db.data[sec].logs].reverse().forEach(l => {
                cont.innerHTML += `<div class="log-item">
                    <div><b>${l.concepto}</b><br><small>POR: ${l.op || 'ADMIN'}</small></div>
                    <div>$${l.monto.toLocaleString()} <span class="del-btn" onclick="eliminarLog('${sec}', ${l.id})">X</span></div>
                </div>`;
            });
        }

        async function eliminarLog(sec, id) {
            if(prompt("Master Key:") === "2026") {
                db.data[sec].logs = db.data[sec].logs.filter(l => l.id !== id);
                updateUI(); await syncCloud(true);
            }
        }

        async function ajustarSaldo(sec) {
            if(prompt("Master Key:") === "2026") {
                let n = prompt("Nuevo Saldo:", db.data[sec].saldo);
                if(n) { db.data[sec].saldo = parseFloat(n); updateUI(); await syncCloud(true); }
            }
        }

        function changeTrack() {
            const p = document.getElementById('main-audio');
            p.src = document.getElementById('track-list').value;
            if(p.src) p.play();
        }

        async function addMusic() {
            const n = prompt("Nombre:"), f = prompt("Archivo .mp3:");
            if(n && f) { db.playlist.push({name:n, file:f}); await syncCloud(true); }
        }

        // Animación de fondo
        const canvas = document.getElementById('canvas-bg'), ctx = canvas.getContext('2d');
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize; resize();
        let stars = Array(150).fill().map(() => ({x: Math.random()*canvas.width, y: Math.random()*canvas.height, z: Math.random()*canvas.width}));
        function anim() {
            ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--primary');
            stars.forEach(s => {
                s.z -= 4; if(s.z<=0) s.z=canvas.width;
                let sx = (s.x-canvas.width/2)*(canvas.width/s.z)+canvas.width/2;
                let sy = (s.y-canvas.height/2)*(canvas.width/s.z)+canvas.height/2;
                ctx.beginPath(); ctx.arc(sx, sy, (canvas.width/s.z), 0, Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(anim);
        }
        anim();
    </script>
</body>
</html>
