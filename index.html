<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VICRO & KASSY | OMEGA CLOUD v29.0</title>
    <style>
        :root {
            --primary: #00ff41; --bg: #000; --card: rgba(10, 10, 10, 0.98);
            --red: #ff3333; --blue: #00ccff; --pink: #ff69b4;
            --text: var(--primary); --dim: #004400; --gold: #ffcc00;
        }
        /* Colores dinámicos por usuario */
        body.vicro-theme { --primary: #00ff41; --dim: #004400; }
        body.kassy-theme { --primary: var(--pink); --dim: #440022; }
        body.user-blue { --primary: var(--blue); --dim: #002244; }
        body.user-gold { --primary: var(--gold); --dim: #443300; }
        body.user-red { --primary: var(--red); --dim: #440000; }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: 'Courier New', monospace; overflow: hidden; color: var(--primary); transition: 0.5s; }
        #canvas-bg { position: fixed; inset: 0; z-index: -1; }

        #biometric-overlay { position: fixed; inset: 0; z-index: 3000; background: #000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .scanner-bar { width: 100%; height: 4px; background: var(--primary); position: absolute; top: 0; box-shadow: 0 0 20px var(--primary); animation: scanLine 2s linear infinite; }
        @keyframes scanLine { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }

        #login-page { position: fixed; inset: 0; z-index: 2000; background: #000; display: flex; justify-content: center; align-items: center; }
        .login-card { text-align: center; width: 90%; max-width: 380px; border: 1px solid var(--primary); padding: 30px; background: #000; box-shadow: 0 0 30px var(--dim); }
        .hacker-input { width: 100%; background: transparent; border: 1px solid var(--dim); padding: 12px; color: var(--primary); outline: none; margin-bottom: 10px; text-align: center; box-sizing: border-box; }
        .btn-hack { width: 100%; background: var(--primary); color: #000; border: none; padding: 12px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-bottom: 5px; }

        #color-selector { display: none; margin-bottom: 15px; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .color-opt { height: 25px; border: 1px solid #fff; cursor: pointer; }

        #main-app { display: none; height: 100vh; flex-direction: column; padding: 15px; box-sizing: border-box; }
        .header { display: flex; justify-content: space-between; border-bottom: 1px solid var(--dim); padding-bottom: 10px; margin-bottom: 10px; font-size: 0.7rem; }
        .content-grid { display: grid; grid-template-columns: 1fr; gap: 15px; overflow-y: auto; }
        @media (min-width: 850px) { .content-grid { grid-template-columns: 1.2fr 1fr; height: 80vh; } }

        .panel { background: var(--card); border: 1px solid var(--dim); padding: 20px; border-radius: 5px; }
        .amount { font-size: 2.5rem; font-weight: bold; margin: 10px 0; cursor: pointer; }
        .log-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #222; font-size: 0.7rem; }
        .del-btn { color: var(--red); cursor: pointer; border: 1px solid var(--red); padding: 2px 5px; }

        #player-vicro { background: #111; border: 1px solid var(--primary); padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        audio { height: 30px; width: 100%; filter: invert(1); margin-top: 5px; }
    </style>
</head>
<body id="body-tag">
    <canvas id="canvas-bg"></canvas>

    <div id="biometric-overlay">
        <div class="scanner-bar"></div>
        <div id="bio-msg">SINCRONIZANDO_CORE_DATABASE...</div>
    </div>

    <div id="login-page">
        <div class="login-card">
            <h2 id="login-title">VORTEX_CLOUD_v29</h2>
            <input type="text" id="user" class="hacker-input" placeholder="USUARIO">
            <input type="password" id="pass" class="hacker-input" placeholder="CONTRASEÑA">
            
            <div id="color-selector">
                <div class="color-opt" style="background: #00ff41" onclick="selectColor('vicro-theme')"></div>
                <div class="color-opt" style="background: #ff69b4" onclick="selectColor('kassy-theme')"></div>
                <div class="color-opt" style="background: #00ccff" onclick="selectColor('user-blue')"></div>
                <div class="color-opt" style="background: #ffcc00" onclick="selectColor('user-gold')"></div>
            </div>

            <button id="btn-main" class="btn-hack" onclick="iniciarEscaneo()">ACCEDER</button>
            <button id="btn-toggle" onclick="toggleAuthMode()" style="background:none; border:none; color:var(--blue); cursor:pointer; font-size:0.6rem; margin-top:10px;">[ CREAR_NUEVO_OPERADOR ]</button>
        </div>
    </div>

    <div id="main-app">
        <div class="header">
            <span id="display-user"></span>
            <span id="sync-indicator">● CLOUD_SYNC_OK</span>
            <button onclick="location.reload()" style="background:var(--red); color:white; border:none; padding: 2px 10px; cursor:pointer;">CERRAR</button>
        </div>

        <div id="player-vicro">
            <div style="display:flex; gap:5px;">
                <select id="track-list" onchange="changeTrack()" style="background:#000; color:var(--primary); flex-grow:1; border:1px solid var(--dim);">
                    <option value="">-- MÚSICA --</option>
                </select>
                <button onclick="addMusic()" style="background:var(--primary); border:none; padding:0 10px; font-weight:bold;">+</button>
            </div>
            <audio controls id="main-audio"></audio>
        </div>

        <div class="content-grid">
            <div class="panel" id="panel-controls"></div>
            <div class="panel">
                <small>[ HISTORIAL_GLOBAL ]</small>
                <div id="panel-logs"></div>
            </div>
        </div>
    </div>

    <script>
        const BIN_ID = '698bb9a743b1c97be975254f';
        const MASTER_KEY = '$2a$10$spjxIrYFxGQiKIYND0MrkOg3V6pY4nV.R/US9pa3CWpGr3Se2vutm';

        let db = {
            auth: {
                vicro: { user: "vicrocrook", pass: "soyelmaster", theme: "vicro-theme" },
                kassy: { user: "kassy10", pass: "ojitosbonitos", theme: "kassy-theme" }
            },
            data: {
                vicro_airtm: { saldo: 2000, logs: [] },
                vicro_cap: { saldo: 100000, logs: [] },
                kassy_caja: { saldo: 0, logs: [] }
            },
            playlist: [
                { name: "Si Antes Te Hubiera Conocido", file: "antestehubieraconocido.mp3" },
                { name: "Papasito", file: "papasito.mp3" },
                { name: "Una Noche en Medellín", file: "unanochemedellin.mp3" },
                { name: "Tití Me Preguntó", file: "titimepregunto.mp3" },
                { name: "Música 5", file: "m5.mp3" },
                { name: "Música 6", file: "m6.mp3" },
                { name: "Música 7", file: "m7.mp3" },
                { name: "Música 8", file: "m8.mp3" }
            ]
        };

        let currentUser = "";
        let selectedTheme = "vicro-theme";
        let isRegisterMode = false;

        async function syncCloud(push = false) {
            try {
                if (push) {
                    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-Master-Key': MASTER_KEY },
                        body: JSON.stringify(db)
                    });
                } else {
                    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                        headers: { 'X-Master-Key': MASTER_KEY, 'X-Bin-Meta': 'false' }
                    });
                    const data = await res.json();
                    if(data.auth) db = data;
                }
                updatePlaylistUI();
            } catch (e) { console.log("Sync Error"); }
        }

        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            document.getElementById('color-selector').style.display = isRegisterMode ? 'grid' : 'none';
            document.getElementById('btn-main').innerText = isRegisterMode ? 'REGISTRAR OPERADOR' : 'ACCEDER';
            document.getElementById('login-title').innerText = isRegisterMode ? 'NUEVA_ENTIDAD' : 'VORTEX_CLOUD_v29';
        }

        function selectColor(theme) {
            selectedTheme = theme;
            document.body.className = theme;
        }

        async function iniciarEscaneo() {
            const u = document.getElementById('user').value.trim().toLowerCase();
            const p = document.getElementById('pass').value.trim();
            
            document.getElementById('biometric-overlay').style.display = 'flex';
            await syncCloud();

            if (isRegisterMode) {
                if (db.auth[u]) { alert("USUARIO EXISTENTE"); }
                else {
                    db.auth[u] = { user: u, pass: p, theme: selectedTheme };
                    db.data[u + "_caja"] = { saldo: 0, logs: [] };
                    await syncCloud(true);
                    alert("REGISTRO EXITOSO");
                    toggleAuthMode();
                }
                document.getElementById('biometric-overlay').style.display = 'none';
                return;
            }

            if (db.auth[u] && db.auth[u].pass === p) {
                currentUser = u;
                document.body.className = db.auth[u].theme || 'vicro-theme';
                setTimeout(() => {
                    document.getElementById('login-page').style.display = 'none';
                    document.getElementById('biometric-overlay').style.display = 'none';
                    showApp();
                }, 1000);
            } else {
                alert("ACCESO DENEGADO");
                document.getElementById('biometric-overlay').style.display = 'none';
            }
        }

        function showApp() {
            document.getElementById('main-app').style.display = 'flex';
            document.getElementById('display-user').innerText = "OP: " + currentUser.toUpperCase();
            updateUI();
            updatePlaylistUI();
        }

        function updatePlaylistUI() {
            const list = document.getElementById('track-list');
            list.innerHTML = '<option value="">-- MÚSICA --</option>';
            db.playlist.forEach(t => {
                let opt = new Option(t.name, t.file);
                list.add(opt);
            });
        }

        function updateUI() {
            const controls = document.getElementById('panel-controls');
            controls.innerHTML = "";
            if(currentUser === "vicro") {
                renderNodo(controls, "vicro_airtm", "AIRTM_NODE", "var(--blue)");
                renderNodo(controls, "vicro_cap", "RESERVA_CAPITAL", "var(--primary)");
                renderLogs('vicro_airtm');
            } else {
                let nodeKey = db.data[currentUser + "_caja"] ? currentUser + "_caja" : "kassy_caja";
                renderNodo(controls, nodeKey, "NODO_PERSONAL", "var(--primary)");
                renderLogs(nodeKey);
            }
        }

        function renderNodo(parent, id, title, color) {
            parent.innerHTML += `
                <div style="margin-bottom: 20px;">
                    <small style="color:${color}">[ ${title} ]</small>
                    <div class="amount" style="color:${color}" onclick="ajustarSaldo('${id}')">$${db.data[id].saldo.toLocaleString()}</div>
                    <input type="text" id="c-${id}" class="hacker-input" placeholder="CONCEPTO">
                    <input type="number" id="m-${id}" class="hacker-input" placeholder="MONTO">
                    <button class="btn-hack" style="background:${color}" onclick="registrar('${id}', 'INGRESO')">DEPÓSITO</button>
                    <button class="btn-hack" style="background:var(--red); color:white" onclick="registrar('${id}', 'GASTO')">GASTO</button>
                </div>`;
        }

        async function registrar(sec, tipo) {
            const det = document.getElementById(`c-${sec}`).value;
            const mon = parseFloat(document.getElementById(`m-${sec}`).value);
            if(!det || isNaN(mon)) return;
            db.data[sec].saldo += (tipo === 'INGRESO' ? mon : -mon);
            db.data[sec].logs.push({ id: Date.now(), concepto: det.toUpperCase(), monto: mon, tipo });
            updateUI();
            await syncCloud(true);
        }

        function renderLogs(sec) {
            const cont = document.getElementById('panel-logs');
            cont.innerHTML = "";
            [...db.data[sec].logs].reverse().forEach(l => {
                cont.innerHTML += `<div class="log-item">
                    <div><b>${l.concepto}</b><br><small>${l.tipo}</small></div>
                    <div>$${l.monto.toLocaleString()}</div>
                </div>`;
            });
        }

        function changeTrack() {
            const player = document.getElementById('main-audio');
            player.src = document.getElementById('track-list').value;
            if(player.src) player.play();
        }

        async function addMusic() {
            const n = prompt("Nombre canción:"), f = prompt("Archivo .mp3:");
            if(n && f) { db.playlist.push({name:n, file:f}); await syncCloud(true); }
        }

        const canvas = document.getElementById('canvas-bg'), ctx = canvas.getContext('2d');
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize; resize();
        let stars = Array(150).fill().map(() => ({x: Math.random()*canvas.width, y: Math.random()*canvas.height, z: Math.random()*canvas.width}));
        function anim() {
            ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--primary');
            stars.forEach(s => {
                s.z -= 4; if(s.z<=0) s.z=canvas.width;
                let sx = (s.x-canvas.width/2)*(canvas.width/s.z)+canvas.width/2;
                let sy = (s.y-canvas.height/2)*(canvas.width/s.z)+canvas.height/2;
                ctx.beginPath(); ctx.arc(sx, sy, (canvas.width/s.z), 0, Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(anim);
        }
        anim();
    </script>
</body>
</html>

