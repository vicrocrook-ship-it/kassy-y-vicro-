<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VICRO & KASSY | OMEGA CLOUD v28.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #00ff41; --bg: #000; --card: rgba(10, 10, 10, 0.98);
            --red: #ff3333; --blue: #00ccff; --pink: #ff69b4;
            --text: var(--primary); --dim: #004400; --gold: #ffcc00;
        }
        body.kassy-mode { --primary: var(--pink); --dim: #440022; --text: var(--pink); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: 'Courier New', monospace; overflow: hidden; color: var(--primary); }
        #canvas-bg { position: fixed; inset: 0; z-index: -1; }

        /* Biometría */
        #biometric-overlay { position: fixed; inset: 0; z-index: 3000; background: #000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .scanner-bar { width: 100%; height: 4px; background: var(--primary); position: absolute; top: 0; box-shadow: 0 0 20px var(--primary); animation: scanLine 2s linear infinite; }
        @keyframes scanLine { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }

        /* Login */
        #login-page { position: fixed; inset: 0; z-index: 2000; background: #000; display: flex; justify-content: center; align-items: center; }
        .login-card { text-align: center; width: 90%; max-width: 380px; border: 1px solid var(--primary); padding: 40px; background: #000; box-shadow: 0 0 30px var(--dim); }
        .hacker-input { width: 100%; background: transparent; border: 1px solid var(--dim); padding: 12px; color: var(--primary); outline: none; margin-bottom: 15px; text-align: center; box-sizing: border-box; }
        .btn-hack { width: 100%; background: var(--primary); color: #000; border: none; padding: 12px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-bottom: 5px; }

        /* App */
        #main-app { display: none; height: 100vh; flex-direction: column; padding: 15px; box-sizing: border-box; }
        .header { display: flex; justify-content: space-between; border-bottom: 1px solid var(--dim); padding-bottom: 10px; margin-bottom: 10px; font-size: 0.7rem; }
        .content-grid { display: grid; grid-template-columns: 1fr; gap: 15px; overflow-y: auto; }
        @media (min-width: 850px) { .content-grid { grid-template-columns: 1.2fr 1fr; height: 80vh; } }

        .panel { background: var(--card); border: 1px solid var(--dim); padding: 20px; border-radius: 5px; overflow-y: auto; }
        .amount { font-size: 2.5rem; font-weight: bold; margin: 10px 0; cursor: pointer; }
        .log-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #222; font-size: 0.7rem; }
        .del-btn { color: var(--red); cursor: pointer; font-weight: bold; border: 1px solid var(--red); padding: 2px 5px; }

        #player-vicro { background: #111; border: 1px solid var(--gold); padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        audio { height: 35px; width: 100%; filter: invert(1) hue-rotate(45deg); }
    </style>
</head>
<body id="body-tag">
    <canvas id="canvas-bg"></canvas>

    <div id="biometric-overlay">
        <div class="scanner-bar"></div>
        <div id="bio-msg" style="letter-spacing: 5px;">SINCRONIZANDO_NUBE_OMEGA...</div>
    </div>

    <div id="login-page">
        <div class="login-card">
            <h2 style="letter-spacing: 5px; font-size: 0.8rem;">VORTEX_CLOUD_v28</h2>
            <input type="text" id="user" class="hacker-input" placeholder="USUARIO">
            <input type="password" id="pass" class="hacker-input" placeholder="CONTRASEÑA">
            <button class="btn-hack" onclick="iniciarEscaneo()">ACCEDER Y SINCRONIZAR</button>
            <div style="margin-top:15px;">
                <button onclick="configAcceso()" style="background:none; border:none; color:var(--gold); cursor:pointer; font-size:0.5rem;">[CAMBIAR_CREDENCIALES_GLOBALES]</button>
            </div>
        </div>
    </div>

    <div id="main-app">
        <div class="header">
            <span id="display-user"></span>
            <span id="sync-indicator" style="color:var(--primary)">● CLOUD_SYNC_OK</span>
            <button onclick="location.reload()" style="background:var(--red); color:white; border:none; padding: 2px 10px; cursor:pointer;">CERRAR</button>
        </div>

        <div id="player-vicro">
            <div style="display: flex; gap: 10px; align-items: center;">
                <select id="track-list" onchange="changeTrack()" style="background:#000; color:var(--primary); flex-grow: 1; border:1px solid var(--dim); padding: 5px;">
                    <option value="">-- SELECCIONAR MÚSICA --</option>
                </select>
                <button onclick="addMusicPrompt()" style="background:var(--gold); border:none; padding: 5px 10px; cursor:pointer; font-weight:bold;">+ ADD</button>
            </div>
            <audio controls id="main-audio" style="margin-top:10px;"></audio>
        </div>

        <div class="content-grid">
            <div class="panel" id="panel-controls"></div>
            <div class="panel">
                <small>[ HISTORIAL_GLOBAL ]</small>
                <div id="panel-logs"></div>
            </div>
        </div>
    </div>

    <script>
        const BIN_ID = '698bb9a743b1c97be975254f';
        const MASTER_KEY = '$2a$10$spjxIrYFxGQiKIYND0MrkOg3V6pY4nV.R/US9pa3CWpGr3Se2vutm';

        // Base de datos extendida con soporte para música
        let db = {
            auth: {
                vicro: { user: "vicrocrook", pass: "soyelmaster" },
                kassy: { user: "kassy10", pass: "ojitosbonitos" }
            },
            data: {
                vicro_airtm: { saldo: 2000, logs: [] },
                vicro_cap: { saldo: 100000, logs: [] },
                kassy_caja: { saldo: 0, logs: [] }
            },
            playlist: [
                { name: "Si Antes Te Hubiera Conocido", file: "antestehubieraconocido.mp3" },
                { name: "Papasito", file: "papasito.mp3" },
                { name: "Una Noche en Medellín", file: "unanochemedellin.mp3" },
                { name: "Tití Me Preguntó", file: "titimepregunto.mp3" }
            ]
        };

        let currentUser = "";

        async function syncCloud(push = false) {
            const indicator = document.getElementById('sync-indicator');
            indicator.style.color = 'orange';
            indicator.innerText = '● SYNCING...';
            
            try {
                if (push) {
                    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-Master-Key': MASTER_KEY },
                        body: JSON.stringify(db)
                    });
                } else {
                    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                        headers: { 'X-Master-Key': MASTER_KEY, 'X-Bin-Meta': 'false' }
                    });
                    const cloudData = await res.json();
                    if(cloudData.auth) {
                        db = cloudData;
                        // Asegurar que la playlist exista si los datos son antiguos
                        if(!db.playlist) db.playlist = [];
                    }
                }
                indicator.style.color = '#00ff41';
                indicator.innerText = '● CLOUD_SYNC_OK';
                updatePlaylistUI();
            } catch (e) {
                indicator.style.color = 'red';
                indicator.innerText = '● SYNC_ERROR';
            }
        }

        function updatePlaylistUI() {
            const list = document.getElementById('track-list');
            const currentVal = list.value;
            list.innerHTML = '<option value="">-- SELECCIONAR MÚSICA --</option>';
            db.playlist.forEach(track => {
                const opt = document.createElement('option');
                opt.value = track.file;
                opt.textContent = track.name;
                list.appendChild(opt);
            });
            list.value = currentVal;
        }

        async function addMusicPrompt() {
            const name = prompt("Nombre de la canción:");
            const file = prompt("Nombre del archivo (ej: cancion.mp3):");
            if(name && file) {
                db.playlist.push({ name, file });
                await syncCloud(true);
                alert("Música sincronizada con éxito");
            }
        }

        async function iniciarEscaneo() {
            const u = document.getElementById('user').value.trim();
            const p = document.getElementById('pass').value.trim();
            document.getElementById('biometric-overlay').style.display = 'flex';
            
            await syncCloud();

            if((u === db.auth.vicro.user && p === db.auth.vicro.pass) || (u === db.auth.kassy.user && p === db.auth.kassy.pass)) {
                currentUser = (u === db.auth.vicro.user) ? "vicro" : "kassy";
                setTimeout(() => {
                    document.getElementById('login-page').style.display = 'none';
                    document.getElementById('biometric-overlay').style.display = 'none';
                    showApp();
                }, 1500);
            } else { 
                alert("DATOS INCORRECTOS"); 
                document.getElementById('biometric-overlay').style.display = 'none';
            }
        }

        function showApp() {
            document.getElementById('main-app').style.display = 'flex';
            document.getElementById('display-user').innerText = "OP: " + currentUser.toUpperCase();
            if(currentUser === "kassy") document.body.classList.add('kassy-mode');
            updateUI();
        }

        function updateUI() {
            const controls = document.getElementById('panel-controls');
            controls.innerHTML = "";
            if(currentUser === "vicro") {
                renderNodo(controls, "vicro_airtm", "AIRTM_NODE", "var(--blue)");
                renderNodo(controls, "vicro_cap", "RESERVA_CAPITAL", "var(--primary)");
                renderLogs('vicro_airtm');
            } else {
                renderNodo(controls, "kassy_caja", "CAJA_MÁGICA ✨", "var(--pink)");
                renderLogs('kassy_caja');
            }
        }

        function renderNodo(parent, id, title, color) {
            parent.innerHTML += `
                <div style="margin-bottom: 30px;">
                    <small style="color:${color}">[ ${title} ]</small>
                    <div class="amount" style="color:${color}" onclick="ajustarSaldo('${id}')">$${db.data[id].saldo.toLocaleString()}</div>
                    <input type="text" id="c-${id}" class="hacker-input" placeholder="CONCEPTO">
                    <input type="number" id="m-${id}" class="hacker-input" placeholder="MONTO $">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="btn-hack" style="background:${color}; color:black;" onclick="registrar('${id}', 'INGRESO')">DEPÓSITO</button>
                        <button class="btn-hack" style="background:var(--red); color:white;" onclick="registrar('${id}', 'GASTO')">GASTO</button>
                    </div>
                </div>`;
        }

        async function registrar(sec, tipo) {
            const det = document.getElementById(`c-${sec}`).value;
            const mon = parseFloat(document.getElementById(`m-${sec}`).value);
            if(!det || isNaN(mon)) return;
            db.data[sec].saldo += (tipo === 'INGRESO' ? mon : -mon);
            db.data[sec].logs.push({ id: Date.now(), concepto: det.toUpperCase(), monto: mon, tipo });
            updateUI();
            await syncCloud(true);
        }

        function renderLogs(sec) {
            const cont = document.getElementById('panel-logs');
            cont.innerHTML = "";
            [...db.data[sec].logs].reverse().forEach(l => {
                cont.innerHTML += `<div class="log-item">
                    <div><b>${l.concepto}</b><br><small>${l.tipo}</small></div>
                    <div>$${l.monto.toLocaleString()} <span class="del-btn" onclick="eliminar('${sec}', ${l.id})">X</span></div>
                </div>`;
            });
        }

        function changeTrack() {
            const player = document.getElementById('main-audio');
            player.src = document.getElementById('track-list').value;
            if(player.src) player.play();
        }

        // Fondo estelar
        const canvas = document.getElementById('canvas-bg'), ctx = canvas.getContext('2d');
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize; resize();
        let stars = Array(150).fill().map(() => ({x: Math.random()*canvas.width, y: Math.random()*canvas.height, z: Math.random()*canvas.width}));
        function anim() {
            ctx.fillStyle = "rgba(0,0,0,0.15)"; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = (currentUser === "kassy") ? "#ff69b4" : "#00ff41";
            stars.forEach(s => {
                s.z -= 4; if(s.z<=0) s.z=canvas.width;
                let sx = (s.x-canvas.width/2)*(canvas.width/s.z)+canvas.width/2;
                let sy = (s.y-canvas.height/2)*(canvas.width/s.z)+canvas.height/2;
                ctx.beginPath(); ctx.arc(sx, sy, (canvas.width/s.z), 0, Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(anim);
        }
        anim();
    </script>
</body>
</html>

