<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OMEGA CLOUD | VICRO CONTROL v31</title>

<style>
:root {
    --primary:#00ff41;
    --bg:#000;
    --card:rgba(15,15,15,0.98);
    --red:#ff3333;
    --blue:#00ccff;
    --pink:#ff69b4;
    --dim:#004400;
    --gold:#ffcc00;
}
body,html{
    margin:0;
    padding:0;
    width:100%;
    height:100%;
    background:#000;
    font-family:'Courier New',monospace;
    overflow:hidden;
    color:var(--primary);
}
#login-page{
    position:fixed;
    inset:0;
    display:flex;
    justify-content:center;
    align-items:center;
}
.login-card{
    width:90%;
    max-width:380px;
    border:1px solid var(--primary);
    padding:30px;
    text-align:center;
}
.hacker-input{
    width:100%;
    background:transparent;
    border:1px solid var(--dim);
    padding:10px;
    color:var(--primary);
    margin-bottom:10px;
    text-align:center;
}
.btn-hack{
    width:100%;
    background:var(--primary);
    color:#000;
    border:none;
    padding:10px;
    cursor:pointer;
    font-weight:bold;
}
#main-app{
    display:none;
    height:100vh;
    flex-direction:column;
    padding:10px;
    overflow-y:auto;
}
.header{
    display:flex;
    justify-content:space-between;
    padding:10px;
    border-bottom:1px solid var(--dim);
}
.panel{
    background:var(--card);
    border:1px solid var(--dim);
    padding:15px;
}
.amount{
    font-size:2rem;
    margin:10px 0;
}
</style>
</head>

<body>

<div id="login-page">
<div class="login-card">
<h2>OMEGA_v31</h2>

<input type="text" id="user" class="hacker-input" placeholder="USUARIO">
<input type="password" id="pass" class="hacker-input" placeholder="CONTRASEÑA">

<button id="btn-main" class="btn-hack" onclick="iniciarEscaneo()">ACCEDER</button>

<div style="margin-top:15px;font-size:0.7rem;">
<span onclick="toggleReg()" id="reg-text" style="color:var(--blue);cursor:pointer;">[REGISTRAR]</span>
</div>
</div>
</div>

<div id="main-app">
<div class="header">
<span id="display-user"></span>
<span>● CORE_CONNECTED</span>
<button onclick="location.reload()" style="background:red;color:white;border:none;padding:5px;">SALIR</button>
</div>

<div id="panel-controls"></div>

<div class="panel">
<small>[ HISTORIAL ]</small>
<div id="panel-logs" style="margin-top:10px;"></div>
</div>
</div>

<script>
const BIN_ID = '698bb9a743b1c97be975254f';
const MASTER_KEY = '$2a$10$spjxIrYFxGQiKIYND0MrkOg3V6pY4nV.R/US9pa3CWpGr3Se2vutm';

let db = { auth:{}, data:{} };
let currentUser="";
let regMode=false;

async function sync(push=false){
    try{
        if(push){
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`,{
                method:'PUT',
                headers:{
                    'Content-Type':'application/json',
                    'X-Master-Key':MASTER_KEY
                },
                body:JSON.stringify(db)
            });
        }else{
            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`,{
                headers:{
                    'X-Master-Key':MASTER_KEY,
                    'X-Bin-Meta':'false'
                }
            });
            const data = await res.json();
            if(data) db=data;
        }
    }catch(e){console.log("SYNC ERROR");}
}

async function iniciarEscaneo(){
    await sync();

    const u=document.getElementById('user').value.toLowerCase().trim();
    const p=document.getElementById('pass').value.trim();

    if(!u||!p) return alert("Campos vacíos");

    if(regMode){
        if(db.auth[u]) return alert("Usuario ya existe");
        db.auth[u]={user:u,pass:p,active:true,last:Date.now()};
        await sync(true);
        alert("Registrado");
        location.reload();
        return;
    }

    if(db.auth[u]&&db.auth[u].pass===p){
        currentUser=u;
        db.auth[u].last=Date.now();
        await sync(true);

        document.getElementById('login-page').style.display='none';
        document.getElementById('main-app').style.display='flex';
        document.getElementById('display-user').innerText="OP: "+u.toUpperCase();
        renderUI();
    }else{
        alert("Credenciales incorrectas");
    }
}

async function mov(id,tipo){
    await sync();

    const c=document.getElementById(`c-${id}`).value.trim();
    const m=parseFloat(document.getElementById(`m-${id}`).value);

    if(!c||isNaN(m)||m<=0) return alert("Datos inválidos");

    if(!db.data[id]) db.data[id]={saldo:0,logs:[]};

    db.data[id].saldo+=(tipo==='IN'?m:-m);

    db.data[id].logs.push({
        t:Date.now(),
        desc:c.toUpperCase(),
        val:m,
        type:tipo,
        op:currentUser
    });

    await sync(true);
    renderUI();
}

function renderUI(){
    const container=document.getElementById('panel-controls');
    container.innerHTML="";

    if(!db.data['principal']) db.data['principal']={saldo:0,logs:[]};

    container.innerHTML=`
    <div class="panel">
        <small>[ CUENTA PRINCIPAL ]</small>
        <div class="amount">$${db.data['principal'].saldo.toLocaleString()}</div>
        <input type="text" id="c-principal" class="hacker-input" placeholder="CONCEPTO">
        <input type="number" id="m-principal" class="hacker-input" placeholder="MONTO">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;">
            <button class="btn-hack" onclick="mov('principal','IN')">DEP</button>
            <button class="btn-hack" style="background:red;color:white;" onclick="mov('principal','OUT')">GAS</button>
        </div>
    </div>
    `;

    renderLogs();
}

function renderLogs(){
    const box=document.getElementById('panel-logs');
    box.innerHTML="";

    let logs=db.data['principal']?.logs||[];
    logs.sort((a,b)=>b.t-a.t).slice(0,20).forEach(l=>{
        box.innerHTML+=`
        <div style="display:flex;justify-content:space-between;padding:5px 0;font-size:0.7rem;">
            <span>${l.desc}<br><small>${l.op}</small></span>
            <span style="color:${l.type==='IN'?'#0f4':'#f44'}">
                ${l.type==='IN'?'+':'-'}$${l.val.toLocaleString()}
            </span>
        </div>`;
    });
}

function toggleReg(){
    regMode=!regMode;
    document.getElementById('btn-main').innerText=regMode?"REGISTRAR":"ACCEDER";
    document.getElementById('reg-text').innerText=regMode?"[VOLVER]":"[REGISTRAR]";
}

setInterval(async()=>{
    if(currentUser){
        await sync();
        renderUI();
    }
},5000);
</script>

</body>
</html>
